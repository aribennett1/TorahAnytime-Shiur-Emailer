{"files":[{"id":"c95f5c40-abfb-4efd-b338-04090799b52a","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"America/New_York\",\n  \"dependencies\": {\n    \"enabledAdvancedServices\": [\n      {\n        \"userSymbol\": \"Gmail\",\n        \"version\": \"v1\",\n        \"serviceId\": \"gmail\"\n      }\n    ]\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"},{"id":"58bf32f9-ff9f-44df-b6e3-81369299bfeb","name":"Code","type":"server_js","source":"function main() {\n  var emails \u003d GmailApp.search(\"from: TorahAnytime Following \u003cfollowing@torahanytime.com\u003e\");\n  for (var i \u003d 0; i \u003c emails.length; i++) {\n    var email \u003d emails[i].getMessages();\n    var plainBody \u003d email[0].getPlainBody();        \n    console.log(\"plainBody: \" + plainBody);\n    var subject \u003d email[0].getSubject();\n    console.log(\"subject: \" + subject);\n    var info \u003d getInfo(plainBody);\n    // for (var j \u003d 0; j \u003c email.length; j++) {\n    //       email[j].moveToTrash();\n    //     }                    \n    Logger.log(\"Email moved to Trash\");\n    var title \u003d getTitle(subject);     \n    console.log(\"Title: \" + title);\n    PropertiesService.getScriptProperties().setProperty(\u0027orgTitle\u0027, title);\n    PropertiesService.getScriptProperties().setProperty(\u0027orgSubject\u0027, subject);\n    var downloadLink \u003d getDownloadLink(info);\n    var shiur \u003d downloadShiur(downloadLink);\n    shiur.setName(title);\n    var parts \u003d Math.ceil(shiur.getBytes().length / 26214400);\n    // emailShiur(shiur, email[0].getBody(), 1, parts);   \n  }\n  removeFromTrash();\n}\n\nfunction getInfo(body) {\n  body \u003d body.substring(body.indexOf(\"https://www.torahanytime.com\"));  \n  var begIndex \u003d body.indexOf(\"lectures?\") + 11;\n  var endIndex \u003d body.indexOf(\"]\");\n  var id \u003d body.substring(begIndex, endIndex);\n  console.log(\"id: \" + id);\n  var link \u003d \"https://www.torahanytime.com/lectures/\" + id;\n  var info \u003d UrlFetchApp.fetch(link);\n  return info.getContentText();\n}\n\nfunction getTitle(subject) {\n  subject \u003d subject.substring(subject.indexOf(\" by \") + 4);\n  var title \u003d subject.toLowerCase().replace(/[^a-zA-Z0-9 \\u0590-\\u05fe-]/g, \"\").replaceAll(\" \", \"-\") + \".mp3\";\n  return title.replaceAll(\"---\", \"-\").replaceAll(\"--\", \"-\").replaceAll(\"-.mp3\", \".mp3\");\n}\n\nfunction getDownloadLink(text) {\n  var text \u003d text.substring(text.indexOf(\"audio_url\") + 12);\n  console.log(\"text: \", text);\n  var endIndex \u003d text.indexOf(\".mp3\\\",\") + 4;\n  console.log(\"endIndex: \", endIndex);\n  var downloadLink \u003d text.substring(0, endIndex);\n  console.log(\"Download Link: \", downloadLink);\n  return downloadLink;\n}\n\nfunction downloadShiur(downloadLink) {\n  var audio \u003d UrlFetchApp.fetch(downloadLink);\n  return audio.getBlob().getAs(\u0027audio/mp3\u0027);\n}\n\nfunction emailShiur(shiur, language, counter, parts) {\n  var byteArray \u003d shiur.getBytes();\n  console.log(\"entered ES\");\nconst maxFileSize \u003d 26214400; //25MB Max File Size Limit by Gmail\nif (counter \u003c\u003d 1) {\n    var subject \u003d \"TA Shiur (File)\"; \n  }\n  else {\n    var subject \u003d \"TA Shiur (File - Part \" + counter + \" of \" + parts + \")\";\n    shiur.setName(PropertiesService.getScriptProperties().getProperty(\u0027orgTitle\u0027).replaceAll(\".mp3\", \"\") + \"-part-\" + counter + \"-of-\" + parts + \".mp3\");\n\n  }\nif (byteArray.length \u003c\u003d maxFileSize) {\n  GmailApp.sendEmail(\"slot700@gmail.com\", subject, \"Language: \" + language + \"\\n\" + shiur.getName() + \"\\nEnjoy!\", {\n      attachments: [shiur],\n      name: \u0027Automatic Emailer Script\u0027\n  });\n  } else {\n    var part1 \u003d byteArray.splice(0, maxFileSize);\n     part1 \u003d Utilities.newBlob(part1, \u0027audio/mp3\u0027, PropertiesService.getScriptProperties().getProperty(\u0027orgTitle\u0027).replaceAll(\".mp3\", \"\") + \"-part-\" + counter + \"-of-\" + parts + \".mp3\");\n     var part2 \u003d Utilities.newBlob(byteArray, \u0027audio/mp3\u0027, PropertiesService.getScriptProperties().getProperty(\u0027orgTitle\u0027).replaceAll(\".mp3\", \"\") + \"-part-\" + (counter + 1) + \" of \" + parts + \".mp3\");\n      GmailApp.sendEmail(\"slot700@gmail.com\", \"TA Shiur (File - Part \" + counter + \" of \" + parts + \")\", \"Language: \" + language + \"\\n\" + part1.getName() + \"\\nEnjoy!\", {\n        attachments: [part1],\n        name: \u0027Automatic Emailer Script\u0027\n      });\n        emailShiur(part2, language, ++counter, parts);        \n  }\n}\n\nfunction removeFromTrash() {\n  var email \u003d Session.getActiveUser().getEmail();\n  var threads \u003d GmailApp.search(\"in:trash from:\" + email + \" subject:TA Shiur older_than:3d\");\n  var skipped \u003d 0;\n  for (var i \u003d 0; i \u003c threads.length; i++) {\n    try {\n      Gmail.Users.Threads.remove(email, threads[i].getId());\n    }\n    catch (err) {\n      console.log(err);\n      skipped++;\n      continue;\n    }\n  }\n  console.log(\"Removed \" + (threads.length - skipped) + \" emails from trash, skipped \" + skipped + \" emails\");\n}"}]}